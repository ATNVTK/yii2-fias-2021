Документация по модулю fias
============================

Модуль fias предназначен для работы с государственным адресным реестром http://fias.nalog.ru/ 


Структура модуля
-------------------

    actions             содержит действия
    console             содержит логику для работы приложения в консоли
        base            содержит модели необходимые для работы модуля в консоли
        controllers     содержит контроллер консольных команд
        models          содержит модели для работы с данными в консоли
        traits          содержит трейты
    controllers         содержит основные контроллеры модуля
    helpers             содержит классы хелперы
    models              сожержит основные модели модуля
    searches            содержит модели поиска
    widgets             содержит виджеты модуля
    Module.php          базовый класс модуля
    
Зависимости
-------------------

Модулю для работы нужно официальное jquery ui расширение (yiisoft/yii2-jui).

Установка
-------------------
Установить модуль с помощью композера:
````
    composer require solbianca/yii2-fias "dev-master"
````

 Применить миграции:
 ````
     php yii migrate/up --migrationPath=@vendor/solbianca/yii2-fias/migrations
 ````
Настройки
-------------------

Задать карту контроллеров:

````
'controllerMap' => [
    'fias' => [
        'class' => 'solbianca\fias\console\controllers\FiasController'
    ]
],
````

В файле конфига подключить модуль:
    
````
    'modules' => [
        ....
            'fias' => [
                'class' => 'solbianca\fias\Module',
            ],
        ....
    ],
````  

Модулю можно указать папку, куда скачивать/распаковывать выгрузку БД ФИАС.
Для ускорения процесса инициализации можно самому скачать выгрузку (XML-файлы, в архиве .RAR)
и разархивировать в эту же папку вручную. 
По умолчанию модулем используется папка @app/runtime/fias

````
    'modules' => [
        ....
            'fias' => [
                ....
                'directory' => path/to/directory
                ....
            ],
        ....
    ],
````
  
Модулю можно указать БД, отличную от БД проекта.

Пример:
````
    'components'          => [
        ....
        'dbFias'     => [
            'class' => 'yii\db\Connection',
            'dsn' => 'mysql:host=my.db.server.domain;dbname=fias',
            'username' => 'db-user',
            'password' => '***',
            'charset' => 'utf8',
            'on afterOpen' => function($event) {
                // $event->sender refers to the DB connection
                $event->sender->createCommand("SET NAMES utf8")->execute();
            }
        ],
        ....
    ],
    ....
    'modules' => [
        ....
            'fias' => [
                ....
                'db' => 'dbFias'
                ....
            ],
        ....
    ],
````
  
Консольные команды
-------------------

#### Важно при первичной инициализации
0. Скачиваемый файл .RAR будет размером ~5Gb
0. Этот файл развернется в 21 файл общим размером ~30Gb
0. Во время заполнения БД на сервере базы данных mysql потребуется ~15Gb свободного места в каталоге tmp под временные файлы
0. Файлы таблиц и ключей будут занимать ~15Gb

Т.о. перед запуском стоит озаботиться наличием достаточного дискового пространства - в сумме около 65Gb
#### Первичная инициализация
````
    php yii fias/install
````
Данный способ требует много времени, так как сначала будет скачиваться файл .RAR размером ~5Gb,
затем он будет разархивироваться, и только затем пойдет импорт данных.

#### Более предпочтительный способ инициализации
Предварительно скачиваем базу, распаковываем и указываем консольному приложению путь до этой папки:
````
    php yii fias/install /path/to/files
````
В силу того, что база имеет большой размер (около 20 гигабайт), импорт полной базы может продолжаться длительное время (десятки минут или даже час и больше, в зависимости от производительности сервера). 

#### Обновление данных
````
    php yii fias/update
````
Приложение сравнивает последнюю версию данных на сервере с последней импортированной версией.
Если различны, скачивает последнюю версию delta_fias и применяет ее.

Очистить рабочую папку для скачки/распаковывания файлов (по умолчанию @app/runtime/fias):
````
    php yii fias/clear-directory
````

Виджет
-----------------------

Для того что бы использовать виджет необходимо в нужном файле представления прописать:

````
<?= app\modules\fias\widgets\autocomplete\Autocomplete::widget() ?>
````

TO DO
-----------------------
